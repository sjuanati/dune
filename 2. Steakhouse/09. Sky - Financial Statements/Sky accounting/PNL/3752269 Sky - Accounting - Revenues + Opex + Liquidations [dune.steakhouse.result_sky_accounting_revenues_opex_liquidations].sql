/*
Maker's accounting remarks:

A) The accounting equation to ensure Maker's double-entry bookkeeping is: Asset = Liability + Equity
   Therefore, any entry will generally consist on:
        1) +Asset | +Liability or +Equity
        2) +Liability |Â -Equity
        3) -Liability | +Equity

B) Maker's accounting is sourced from:
    B1) The Vat contract (core accounting system):
        - move calls where dst = Vow -> +equity | -liability (ie: trading revs, d3m revs, rwa yield, psm yield, MKR mints)
        - move calls where src = Vow -> -equity | +liability (ie: MRK burns)
        - suck calls where dst = Vow -> -equity | +liability (ie: maintenance costs [opex], other sin inflows)
        - suck calls where src = Vow -> +equity | -liability (ie: sin inflows)
        - fess calls -> -equity | +liability (ie: liquidation expenses)
        - grab calls -> +equity | -liability (ie: liquidation revs)
        - frob + grab + fold calls -> +assets | +liability (ie: lending revs)
    B2) Treasury address
        - transfer events from/to treasury -> +assets | +equity
    B3) DssVest contract (token vesting plan for contributors):
        - create/yank calls -> +- equity (ie: MKR vests)

References:
1) RWA yield
    https://forum.makerdao.com/t/introducing-rwa-registry/19782
    https://forum.makerdao.com/t/rwa015-project-andromeda-technical-assessment/20974/8

Changelog:
    2024-08-26: Include LITE-PSM for Revenues in PSM addresses table.
    2024-10-29: Added maker collaterals reference to new query.
    2024-10-30: Merge query to the new query.
    2024-11-03: Change Sky Collaterals Query for the ILK params.
    2024-12-29: Add LITE-PSM-USDC-A in PSM revenues
    2025-03-07: Add USDSJoin into exclusion for liquidation revenues
    2025-03-13: Add SBE liquidity Unwind
    2025-04-22: Reclassify Sin Inflow to Sin Inflow (For SBE unwind)
    2025-05-07: Add comment in March
    2025-05-11: Split MKR burns (so it does not cause issues for USDS/DAI balances)
    2025-09-01: Split OpEx expenses as suggested codes
    2025-11-02: Split OpEx expenses for SKY Foundation expenses

TO BE REVIEWED (create ticket):
- mkr_burns_preunioned : MKR burn requires logic update
- psm_yield_txns: are there other payment contracts?
- why lending revenues increase both assets and liabilities (breaks double-entry accounting)?

TODO:
- standardize tx_hash, call_tx_hash, tx..... USE THE SAME: probably tx_hash
- header
*/

with
    -- ***************************************************************************
    -- ********************* T R A D I N G   R E V E N U E S *********************
    -- ***************************************************************************
    -- get PSM addresses
    psms as (
        select
            u as psm_address,
            from_utf8(bytearray_rtrim(i)) as ilk
        from maker_ethereum.vat_call_frob
        where from_utf8(bytearray_rtrim(i)) like '%PSM%'
        and call_success
        group by 1, 2
    ),
    -- Trading fees generated by PSM swaps that are transferred to the Vow as a revenue
    -- accounting entry (e.g.: user swapping 100 USDC and receiving 99.9 DAI with a
    -- 0.1% fee means that 0.1 DAI-equivalent (rad) remains in the system as a revenue)
    trading_revenues_preunion as (
        select
            call_block_time as ts,
            call_tx_hash as hash,
            ilk,
            sum(1e-45 * rad) as value
        from maker_ethereum.vat_call_move vat
        inner join psms
            on vat.src = psms.psm_address
        where vat.call_success
        and vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        group by 1, 2, 3
    ),
    trading_revenues as (
        select
            ts,
            hash,
            31310 as account_id,  -- trading revenues
            value as value,       -- increased equity
            ilk
        from trading_revenues_preunion
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            -value as value,     -- reduced liability
            ilk
        from trading_revenues_preunion
    ),
    -- ***************************************************************************
    -- ************************* D 3 M   R E V E N U E S *************************
    -- ***************************************************************************
    d3m_revenues_preunion as (
        -- TBR: Dai moved from vaults associated to D3M direct deposits
        -- into the Vow contract, which handles system surplus and debt
        select
            call_block_time as ts,
            call_tx_hash as hash,
            case
                when src = 0xa13c0c8eb109f5a13c6c90fc26afb23beb3fb04a then 'DIRECT-AAVEV2-DAI'
                when src = 0x621fe4fde2617ea8ffade08d0ff5a862ad287ec2 then 'DIRECT-COMPV2-DAI'
            end as ilk,
            sum(1e-45 * rad) as value
        from maker_ethereum.vat_call_move
        where call_success
        and src in (
            0xa13c0c8eb109f5a13c6c90fc26afb23beb3fb04a,      -- Aave V2 D3M
            0x621fe4fde2617ea8ffade08d0ff5a862ad287ec2)      -- Compound v2 D3M
        and dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        group by 1, 2, 3
        union all
        -- TBR: Liquidations where dai (dart) is destroyed. The associated ilks are D3M-related:
        -- DIRECT-COMPV2-DAI, IRECT-SPARK-MORPHO-DAI, DIRECT-AAVEV2-DAI and DIRECT-AAVEV2-DAI
        select
            call_block_time ts,
            call_tx_hash hash,
            from_utf8(bytearray_rtrim(i)) as ilk,
            sum(1e-18 * dart) as value
        from maker_ethereum.vat_call_grab
        where call_success
        and dart > 0
        group by 1, 2, 3
    ),
    d3m_revenues as (
        select
            ts,
            hash,
            31160 as account_id, -- D3M SF
            value as value,      -- increased equity
            ilk
        from d3m_revenues_preunion 
        union all
        select
            ts,
            hash,
            21120 as account_id, -- Dai
            -value as value,     -- reduced liability
            ilk
        from d3m_revenues_preunion 
    ),
    -- ***************************************************************************
    -- **************************** R W A   Y I E L D ****************************
    -- ***************************************************************************
    rwa_yield_txns as (
        select distinct
            call_tx_hash,
            case
                when usr = 0xef1b095f700be471981aae025f92b03091c3ad47 then 'RWA007-A'
                when usr = 0x6c6d4be2223b5d202263515351034861dd9afdb6 then 'RWA009-A'
                when usr = 0x71ec6d5ee95b12062139311ca1fe8fd698cbe0cf then 'RWA014-A'
                when usr = 0xc27C3D3130563C1171feCC4F76C217Db603997cf then 'RWA015-A'
            end as ilk
        from maker_ethereum.dai_call_burn
        where call_success
        and usr in (
            0x6c6d4be2223b5d202263515351034861dd9afdb6, -- RwaJar for RWA009-A (HVBank)
            0xef1b095f700be471981aae025f92b03091c3ad47, -- RwaJar for RWA007-A (Monetalis Clydesdale MIP65)
            0x71ec6d5ee95b12062139311ca1fe8fd698cbe0cf, -- RwaJar for RWA014-A (Coinbase Custody) 
            0xc27C3D3130563C1171feCC4F76C217Db603997cf  -- RwaJar for RWA015-A (BlockTower Andromeda) 
        )
    ),
    rwa_yield_preunioned as (
        select
            vat.call_block_time as ts,
            vat.call_tx_hash as hash,
            ilk,
            sum(vat.rad * 1e-45) as value
        from maker_ethereum.vat_call_move vat
        join rwa_yield_txns tx
            on vat.call_tx_hash = tx.call_tx_hash
        where vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- vow
        and vat.call_success
        group by 1, 2, 3
    ),
    rwa_yield as (
        select
            ts,
            hash,
            coalesce(equity_code, 31170) as account_id, -- default to off-chain private credit
            value as value, -- increased equity
            ilk
        from rwa_yield_preunioned
        left join (
            select ilk, max(equity_account_id) as equity_code
            from query_3685400 -- Maker - Collaterals - Detailed v2
            where ilk like 'RWA%'
            group by 1
        ) as rwa_assets using (ilk)
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            -value as value,     -- decreased liability
            ilk
        from rwa_yield_preunioned
    ),
    -- ***************************************************************************
    -- **************************** P S M   Y I E L D ****************************
    -- ***************************************************************************
    -- TODO: check if all PSMs are included
    psm_yield_txns as (
        select
            call_tx_hash,
            case
                when usr = 0xf2e7a5b83525c3017383deed19bb05fe34a62c27 then 'PSM-GUSD-A'
                when usr = 0x8bf8b5c58bb57ee9c97d0fea773eee042b10a787 then 'PSM-USDP-A'
                WHEN usr = 0x69ca348bd928a158ade7aa193c133f315803b06e THEN 'LITE-PSM-USDC-A'
            end as ilk
        from maker_ethereum.dai_call_burn
        where call_success
        and usr in (
            0xf2e7a5b83525c3017383deed19bb05fe34a62c27, -- PSM GUSD Jar
            0x8bf8b5c58bb57ee9c97d0fea773eee042b10a787, -- PSM PAX Jar
            0x69ca348bd928a158ade7aa193c133f315803b06e  -- Lite PSM USDC Jar
         ) 
        group by 1, 2 
    ),
    psm_yield_preunioned as (
        select
            vat.call_block_time as ts,
            vat.call_tx_hash as hash,
            tx.ilk,
            sum(vat.rad * 1e-45) as value
        from maker_ethereum.vat_call_move vat
        inner join psm_yield_txns tx
            on vat.call_tx_hash = tx.call_tx_hash
        where vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and vat.call_success
        group by 1, 2, 3
    ),
    psm_yield as (
        select
            ts,
            hash,
            31180 as account_id, -- yielding stablecoin interest
            value as value,      -- increased equity
            ilk
        from psm_yield_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id,   -- dai
            -value as value,       -- decreased liability
            ilk
        from psm_yield_preunioned
    ),
    -- ***************************************************************************
    -- ******************* W O R K F O R C E   E X P E N S E S *******************
    -- ***************************************************************************
    team_dai_burns_txns as (
        select distinct
            call_tx_hash,
            usr,
            case 
                when usr = 0x0048fc4357db3c0f45adea433a07a20769ddb0cf -- DssBlow
                then false
                else dao_wallet.wallet_label like '% Keepers'
            end as is_keeper
        from maker_ethereum.dai_call_burn dcb
        --left join query_3149913 dao_wallet
        left join query_3689842 dao_wallet -- dataset
            on dcb.usr = dao_wallet.wallet_address
        where dcb.call_success
        and (dcb.usr = 0x0048fc4357db3c0f45adea433a07a20769ddb0cf or dao_wallet.wallet_address is not null)
    ),
    team_dai_burns_preunioned as (
        select
            vat.call_block_time as ts,
            vat.call_tx_hash as hash,
            tx.is_keeper,
            sum(1e-45 * vat.rad) as value
        from maker_ethereum.vat_call_move vat
        join team_dai_burns_txns tx -- Flop income (coming directly from users wallets)
            on vat.call_tx_hash = tx.call_tx_hash
        where vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and vat.call_success
        group by 1, 2, 3
    ),
    team_dai_burns as (
        select 
            ts,
            hash,
            case
                when is_keeper
                then 31710  -- Keeper Maintenance
                else 31730  -- Returned Workforce Expenses
            end as account_id,
            value as value -- increased equity
        from team_dai_burns_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            -value as value      -- decreased liability
        from team_dai_burns_preunioned
    ),
    -- ***************************************************************************
    -- ********************************* O P E X *********************************
    -- ***************************************************************************
    -- Dai minted without collateral for maintenance operations; get suck txn hashses
    -- from Treasury/Vesting contracts to the Vow ('v' is source, 'u' is destination),
    opex_suck_txns as (
        select call_tx_hash
        from maker_ethereum.vat_call_suck
        where call_success
        and u = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and v in (
            0xbe8e3e3618f7474f8cb1d074a26affef007e98fb, -- Pause Proxy
            0x2cc583c0aacdac9e23cb601fda8f1a0c56cdcb71, -- Vest Dai Legacy
            0xa4c22f0e25c6630b2017979acf1f865e94695c4b) -- Vest Dai
        and rad != 0
        group by 1
    )
    , interest_accruals as (
        select * from query_3754893 -- Maker - Interest Accruals v2
    )
    , star_capital_txs(usr, hash) as (
        -- Transfers to Stars for funding Genesis Capital
        VALUES
        -- https://forum.sky.money/t/atlas-edit-weekly-cycle-proposal-week-of-2025-06-23/26701
        (0x3300f198988e4c9c63f75df86de36421f06af8c4, 0x666eb7807c1b4098f9b91658eb008e8931063c5050e4dbe28bd6fac3a2948d02),
        -- https://forum.sky.money/t/monthly-settlement-cycle-1-july-august-september-18-2025-spell/27173
        (0x1369f7b2b38c76b6478c0f0e66d94923421891ba, 0x0d42cb72cf7e58c7a7df17d976e7421c453318344138be55b1fc4e2db4655a74),
        -- https://forum.sky.money/t/technical-scope-launch-of-the-agent-4-allocation-system/27314
        (0x8be042581f581e3620e29f213ea8b94afa1c8071, 0x865f7bbd3976013411cb77c68822b362f50ea114c798257c1a041352e6ffc518)
        
    )
    , opex_conversions as (
        -- DAI -> USDS Conversions OpEx
        -- Check if the DaiToUSDS is called in the txs.
        SELECT evt_block_time as ts
            , evt_tx_hash as hash
            , dao_wallet.code
            , conv.caller
            , conv.usr
            , dao_wallet.wallet_label
            , CASE
                when dao_wallet.code in ('GELATO', 'KEEP3R', 'CHAINLINK', 'TECHOPS') then 31710 -- Keeper Maintenance
                -- when dao_wallet.wallet_label like '%Auditor%' then 31711 -- Auditor Expenses
                when dao_wallet.code = 'GAS' then 31630 -- Oracle Gas Expenses
                -- when dao_wallet.code in ('LAUNCH', 'MULTICHAIN', 'EGE-001') THEN 31720 -- Workforce Expenses
                when star.hash is not null THEN 317216 -- Star Transfers
                when dao_wallet.code in ('SPK-SUBDAO') THEN 317211 -- Endgame Spark Cost of Revenue
                when dao_wallet.code in ('GRO-SUBDAO') THEN 317212 -- Endgame Grove Cost of Revenue
                when dao_wallet.code in ('OBX-SUBDAO') THEN 317213 -- Endgame Obex Cost of Revenue
                when dao_wallet.code in ('COUNCIL', 'FRONT', 'FORTIFY') THEN 317214 -- Endgame Foundation & Core Expenses
                when dao_wallet.code in ('EGE-001') THEN 317215 -- Endgame Edge Expenses
                else 31740 -- Direct to Third Party Expenses
            END as account_id
            , wad
            , wad / POWER(10, 18) as value
        FROM usds_ethereum.daiusds_evt_daitousds as conv
            join opex_suck_txns opex
                on conv.evt_tx_hash = opex.call_tx_hash
            left join query_3689842 dao_wallet -- dataset
                on conv.usr = dao_wallet.wallet_address
            left join star_capital_txs as star
                on conv.usr = star.usr
                and conv.evt_tX_hash = star.hash
            left join interest_accruals as frobs
                on conv.evt_tx_hash = frobs.hash
                and conv.wad = frobs.dart
        WHERE caller = 0xBE8E3e3618f7474F8cB1d074A26afFef007E98FB -- DS Pause Proxy
        and frobs.hash is null

    )
    -- get Dai amount out of the above suck txns
    , opex_preunion as (
        select
            mints.call_block_time as ts,
            mints.call_tx_hash as hash,
            case
                when dao_wallet.code in ('GELATO', 'KEEP3R', 'CHAINLINK', 'TECHOPS') then 31710 -- Keeper Maintenance
                -- when dao_wallet.wallet_label like '%Auditor%' then 31711 -- Auditor Expenses
                when dao_wallet.code = 'GAS' then 31630 -- Oracle Gas Expenses
                -- when dao_wallet.code in ('LAUNCH', 'MULTICHAIN', 'EGE-001', 'ENDGAME') THEN 31721 -- Endgame Expenses
                when dao_wallet.code is not null then 31720 -- Workforce Expenses
                else 31740 -- Direct to Third Party Expenses
            end as account_id, 
            mints.wad/POWER(10, 18) as value
        from maker_ethereum.dai_call_mint mints
        join opex_suck_txns opex
            on mints.call_tx_hash = opex.call_tx_hash
        --left join query_3149913 as dao_wallet
        left join query_3689842 dao_wallet -- dataset
            on mints.usr = dao_wallet.wallet_address
        left join interest_accruals as frobs
            on mints.call_tx_hash = frobs.hash
            and mints.wad = frobs.dart
        left join opex_conversions as conv
            on mints.call_tx_hash = conv.hash
            and mints.wad = conv.wad
            and mints.usr = conv.caller -- Is Pause Proxy
        where mints.call_success
        and frobs.hash is null -- filtering out draws from psm that happened in the same tx as expenses
        and conv.hash is null -- filtering out dai sent to the Pause Proxy but not converted and distributed.
        union all
        select ts, hash, account_id, value
        from opex_conversions
    )
    , opex as (
        select
            ts,
            hash,
            account_id,     -- Keeper|Oracle Gas|Workforce|3rd Party Expenses
            -value as value -- decreased equity
        from opex_preunion
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            value as value       -- increased liability
        from opex_preunion
    ),
    -- ***************************************************************************
    -- **************************** M K R   B U R N S ****************************
    -- ***************************************************************************
    -- Stablecoin movement amongst users with the Vault Engine
    -- Prior to 2022-01-26 01:31, MKR Burns were from the Vow to the Flap
    -- Today the Maker Smart Burn Engine burns MKR by only being held by liquidity pools.
    mkr_burns_preunioned as (
        select
            call_block_time as ts,
            call_tx_hash as hash,
            sum(rad * 1e-45) as value
        from maker_ethereum.vat_call_move
        where src = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and dst in (
            0xdfe0fb1be2a52cdbf8fb962d5701d7fd0902db9f -- Flapper: Ended 2020 Feb
            , 0xc4269cc7acdedc3794b221aa4d9205f564e27f0d -- Flapper: Ended 2022 Jan
        )
        and call_success
        group by 1, 2
    ),
    mkr_burns as (
        select
            ts,
            hash,
            31420 as account_id,  -- MKR Burns
            -value as value       -- decreased equity
        from mkr_burns_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            value as value       -- increased liability
        from mkr_burns_preunioned
    ),
    -- ***************************************************************************
    -- **************************** M K R   M I N T S ****************************
    -- ***************************************************************************
    psm_contracts as (
        select contract_address from query_3150123 where contract_type = 'PSM'
    ),
    -- Flip -> When vault becomes undercollateralized, liquidation! -> debt auction: Dai from bidders is collected to repay debt + liq penalty
    -- Flop -> When liquidation can't repay all debt -> bad debt auction: Dai from bidders is collected in exchange of minted MKR to cover the bad debt 
    -- Flap -> When excess DAI (all liabilities already covered) -> surplus auction: excess Dai is used to buy back MKR that will be burned
    flapflop_contracts as (
        select contract_address from query_3150123 where contract_type = 'FlapFlop'
    ),
    flapflop_txns as (
        select distinct t.tx_hash
        from ethereum.traces t
        where t.block_time > date '2019-11-01'
        and exists (
            select 1
            from flapflop_contracts c
            where t."from" = c.contract_address
        )
    ),
    mkr_mints_preunioned as (
        select
            vat.call_block_time as ts,
            vat.call_tx_hash as hash,
            sum(vat.rad * 1e-45) as value
        from maker_ethereum.vat_call_move vat
        join flapflop_txns tx -- Flop income (coming directly from users wallets)
            on vat.call_tx_hash = tx.tx_hash
        where vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and vat.call_success
        and vat.src not in (select contract_address from psm_contracts) -- already in Trading revenues
        group by 1, 2
    ),
    mkr_mints as (
        select
            ts,
            hash,
            31410 as account_id, -- MKR Mints
            value as value       -- increased equity
        from mkr_mints_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id,  -- dai
            -value as value       -- decreased liability
        from mkr_mints_preunioned
    ),
    -- ***************************************************************************
    -- ************************* L I Q U I D A T I O N S *************************
    -- ***************************************************************************
    liquidation_excluded_txns as (
        select tx_hash as tx from flapflop_txns -- already included in MKR Mints (mkr_mints_preunioned)
        union all
        select call_tx_hash from team_dai_burns_txns -- already included in Workforce (team_dai_burns_preunioned)
        union all
        select call_tx_hash from psm_yield_txns -- already included in PSM yield (psm_yield_preunioned)
        union all
        select call_tx_hash from rwa_yield_txns -- already included in RWA yield (rwa_yield_preunioned)
    ),
    liquidation_excluded_addr as (
        select contract_address as addr from psm_contracts -- already included in Trading Revenues (trading_revenues_preunion)
        union all
        select 0xa13c0c8eb109f5a13c6c90fc26afb23beb3fb04a -- Aave V2 D3M -> already included in D3M Revenues (d3m_revenues_preunion) 
        union all
        select 0x621fe4fde2617ea8ffade08d0ff5a862ad287ec2 -- Compound V2 D3M -> already included in D3M Revenues (d3m_revenues_preunion) 
        UNION ALL
        SELECT 0x3c0f895007ca717aa01c8693e59df1e8c3777feb -- USDSJoin -> relates to txs DAI <-> USDS that are not liquidated included in SBE Unwind (sbe_unwind_preunioned) 
    ),
    -- considering liquidation any vat move to the vow not previously classified
    liquidation_revenues as (
        select
            call_block_time as ts,
            call_tx_hash as hash,
            sum(rad * 1e-45) as value
        from maker_ethereum.vat_call_move
        left join liquidation_excluded_txns et
            on call_tx_hash = et.tx
        left join liquidation_excluded_addr ea
            on src = ea.addr
        where dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and call_success
        and et.tx is null
        and ea.addr is null
        group by 1, 2
    ),
    liquidation_expenses as (
        select
            call_block_time as ts,
            call_tx_hash as hash,
            sum(tab * 1e-45) as value
        from maker_ethereum.vow_call_fess
        where call_success
        group by 1, 2
    ),
    liquidation as (
        select
            ts,
            hash,
            31210 as account_id, -- liquidation revenues
            value as value       -- increased equity
        from liquidation_revenues
        union all
        select
            ts,
            hash,
            21120 as account_id,  -- dai
            -value as value       -- decreased liability
        from liquidation_revenues
        union all
        select
            ts,
            hash,
            31620 as account_id,  -- liquidation expenses
            -value as value       -- decreased equity
        from liquidation_expenses
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            value as value       -- increased liability
        from liquidation_expenses
    ),

    -- ***************************************************************************
    -- **************************** S B E   B U R N S ****************************
    -- ***************************************************************************
    -- Stablecoin movement amongst users with the Vault Engine
    -- This shows the Maker Smart Burn Engine burns MKR by only being held by liquidity pools.
    sbe_burns_preunioned as (
        select
            call_block_time as ts,
            call_tx_hash as hash,
            sum(rad * 1e-45) as value
        from maker_ethereum.vat_call_move
        where src = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and dst in (
            0x0c10ae443ccb4604435ba63da80ccc63311615bc -- FlapperUniV2: Ended 2024 Sept
        )
        and call_success
        group by 1, 2
    ),
    sbe_burns as (
        select
            ts,
            hash,
            31420 as account_id,  -- MKR Burns
            -value as value       -- decreased equity
        from sbe_burns_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id, -- dai
            value as value       -- increased liability
        from sbe_burns_preunioned
    ),
    -- ***************************************************************************
    -- ***************** S B E   L I Q U I D I T Y   U N W I N D *****************
    -- ***************************************************************************
    sbe_unwind_preunioned as (
        -- TBR: USDS was pulled from Smart Burn Engine (UNIV2 Pool) converted to DAI
        -- and sent into the Vow contract, which handles system surplus and debt
        -- http://forum.sky.money/t/bonapublica-aligned-delegate-communication/20451/154
        select
            vat.call_block_time as ts,
            vat.call_tx_hash as hash,
            sum(vat.rad * 1e-45) as value
        from maker_ethereum.vat_call_move vat
        where vat.dst = 0xa950524441892a31ebddf91d3ceefa04bf454466 -- Vow
        and vat.src = 0x3c0f895007ca717aa01c8693e59df1e8c3777feb -- sUSDS Join
        and vat.call_success
        group by 1, 2
    ),
    sbe_unwind as (
        select
            ts,
            hash,
            31410 as account_id, -- mkr mints/burns (temp reclassified)
            value as value       -- increased equity
        from sbe_unwind_preunioned
        union all
        select
            ts,
            hash,
            21120 as account_id,  -- dai
            -value as value       -- decreased liability
        from sbe_unwind_preunioned
    ),
    -- ***************************************************************************
    -- ******************************* T O T A L S *******************************
    -- ***************************************************************************
    totals as (
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'Returned Workforce Expenses' as descriptor,
            null as ilk
        from team_dai_burns
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'OpEx' as descriptor,
            null as ilk
        from opex
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'Trading Revenues' as descriptor,
            ilk
        from trading_revenues
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'Liquidation Revenues/Expenses' as descriptor,
            null as ilk
        from liquidation
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'RWA Yield' as descriptor,
            ilk
        from rwa_yield
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'PSM Yield' as descriptor,
            ilk
        from psm_yield
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'MKR Burns' as descriptor,
            null as ilk
        from mkr_burns
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'MKR Mints' as descriptor,
            null as ilk
        from mkr_mints
        union all
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'D3M Revenues' as descriptor,
            ilk
        from d3m_revenues
        UNION ALL
        select
            ts,
            hash,
            account_id,
            value,
            'DAI' as token,
            'SBE Burns' as descriptor, -- Smart Burn Engine Burns
            null as ilk
        FROM sbe_burns
        UNION ALL
        select
            ts,
            hash,
            account_id,
            value,
            'USDS' as token,
            'SBE Unwind' as descriptor, -- Smart Burn Engine Unwind
            null as ilk
        FROM sbe_unwind
    )

-- check 1
--select sum(value) as grand_total from totals where date(ts) < date '2024-05-21'
-- check 2
-- select account_id, sum(value) as value from hashless_trxns where date(ts) < date '2024-05-21' group by 1
-- accruals
--select * from loan_actions where date(ts) < date '2024-05-21'

-- final
select * from totals
